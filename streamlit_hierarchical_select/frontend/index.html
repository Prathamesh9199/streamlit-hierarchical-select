<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Hierarchical Select</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- 1. Theming (Anthropic / Modern Clean) --- */
        :root {
            --primary: #FF4B4B; 
            --bg-color: #ffffff;
            --text-main: #31333F;
            --text-light: #808495;
            --border-color: #e0e2e6;
            --hover-bg: #f0f2f6;
            --radius: 8px;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
            --font-stack: "Source Sans Pro", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            margin: 0;
            padding: 1rem;
            font-family: var(--font-stack);
            color: var(--text-main);
            background: transparent;
            height: 450px;
            overflow: hidden; 
        }

        /* --- 2. Main Input (The Trigger) --- */
        .search-wrapper {
            position: relative;
            width: 100%;
        }

        .search-box {
            width: 100%;
            padding: 10px 35px 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 14px;
            outline: none;
            background: var(--bg-color);
            transition: border 0.2s, box-shadow 0.2s;
            cursor: text;
        }

        .search-box:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(255, 75, 75, 0.2);
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            pointer-events: none;
        }

        /* --- 3. The Dropdown Panel (Hidden by default) --- */
        .dropdown-panel {
            position: absolute;
            top: 45px; 
            left: 0;
            width: 100%;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            display: none; 
            flex-direction: column;
            z-index: 100;
            animation: fadeIn 0.15s ease-out;
            max-height: 350px;
        }

        .dropdown-panel.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- 4. Tree Container --- */
        .tree-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .tree-container::-webkit-scrollbar { width: 6px; }
        .tree-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        .tree-container::-webkit-scrollbar-thumb:hover { background: #bbb; }

        /* Tree Items */
        .tree-node-row {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            cursor: pointer;
            transition: background 0.1s;
            font-size: 14px;
            user-select: none;
        }

        .tree-node-row:hover {
            background-color: var(--hover-bg);
        }

        .indent-0 { margin-left: 0; }
        .indent-1 { margin-left: 20px; border-left: 1px solid #eee; }
        .indent-2 { margin-left: 40px; border-left: 1px solid #eee; }
        .indent-3 { margin-left: 60px; border-left: 1px solid #eee; }

        input[type="checkbox"] {
            accent-color: var(--primary);
            width: 15px;
            height: 15px;
            margin-right: 8px;
            cursor: pointer;
        }

        .toggle-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 4px;
            color: var(--text-light);
            border-radius: 4px;
            font-size: 10px;
            transition: transform 0.2s;
        }
        
        .toggle-icon:hover { background: #eee; color: #333; }
        .toggle-icon.collapsed { transform: rotate(-90deg); }
        .toggle-placeholder { width: 24px; }

        .meta-options {
            padding-bottom: 5px;
            margin-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }

        /* Footer */
        .select-footer {
            padding: 10px 12px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            background: #fcfcfc;
            border-radius: 0 0 var(--radius) var(--radius);
        }

        .btn {
            padding: 6px 16px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .btn-secondary {
            background: white;
            border: 1px solid var(--border-color);
            color: var(--text-main);
        }
        .btn-secondary:hover { background: var(--hover-bg); }

        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover { opacity: 0.9; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="search-wrapper">
        <input type="text" class="search-box" id="searchInput" placeholder="Search or select options..." autocomplete="off">
        <i class="fa-solid fa-chevron-down search-icon" id="searchIcon"></i>
        
        <div class="dropdown-panel" id="dropdownPanel">
            
            <div class="tree-container">
                <div class="meta-options">
                    <div class="tree-node-row">
                        <input type="checkbox" id="selectAll">
                        <label for="selectAll" style="cursor:pointer; flex-grow:1;">(Select All Search Results)</label>
                    </div>
                </div>

                <div id="treeRoot"></div>
            </div>

            <div class="select-footer">
                <button class="btn btn-secondary" id="cancelBtn">Cancel</button>
                <button class="btn btn-primary" id="okBtn">Apply Selection</button>
            </div>
        </div>
    </div>

    <script>
        function sendToStreamlit(type, data) {
            window.parent.postMessage({
                isStreamlitMessage: true,
                type: type,
                ...data
            }, "*");
        }

        function updateHeight(expanded) {
            const height = expanded ? 450 : 50; 
            sendToStreamlit("streamlit:setFrameHeight", { height: height });
        }

        function sendData(value) {
            sendToStreamlit("streamlit:setComponentValue", { value: value });
        }

        let treeData = [];

        window.addEventListener("message", (event) => {
            if (event.data.type === "streamlit:render") {
                const { args } = event.data;
                if (!window.rendered) {
                    treeData = args.data;
                    renderTree(treeData, document.getElementById('treeRoot'));
                    window.rendered = true;
                    updateHeight(false); 
                }
            }
        });

        sendToStreamlit("streamlit:componentReady", { apiVersion: 1 });

        // --- Logic & Interactions ---

        const searchInput = document.getElementById('searchInput');
        const dropdownPanel = document.getElementById('dropdownPanel');
        const selectAllCheckbox = document.getElementById('selectAll');
        const searchIcon = document.getElementById('searchIcon');

        searchInput.addEventListener('click', () => {
            dropdownPanel.classList.add('active');
            searchIcon.classList.replace('fa-chevron-down', 'fa-magnifying-glass');
            updateHeight(true);
        });

        selectAllCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            const allVisibleNodes = document.querySelectorAll('.node-wrapper:not(.hidden) > .tree-node-row input[type="checkbox"]');
            
            allVisibleNodes.forEach(cb => {
                cb.checked = isChecked;
                cb.indeterminate = false;
            });

            const visibleRoots = document.querySelectorAll('#treeRoot > .node-wrapper:not(.hidden)');
            visibleRoots.forEach(root => {
                const cb = root.querySelector('input');
                propagateDown(root, isChecked);
            });
        });

        function propagateDown(wrapper, isChecked) {
             const childrenContainer = wrapper.querySelector('.children-container');
             if(childrenContainer) {
                 const children = childrenContainer.querySelectorAll('.node-wrapper:not(.hidden)');
                 children.forEach(child => {
                     const childCb = child.querySelector('.tree-node-row input');
                     if(childCb) {
                         childCb.checked = isChecked;
                         childCb.indeterminate = false;
                         propagateDown(child, isChecked);
                     }
                 });
             }
        }

        function renderTree(nodes, container, level = 0) {
            nodes.forEach(node => {
                const nodeWrapper = document.createElement('div');
                nodeWrapper.classList.add('node-wrapper');
                nodeWrapper.setAttribute('data-id', node.id);
                nodeWrapper.setAttribute('data-label', node.label.toLowerCase());

                const row = document.createElement('div');
                row.classList.add('tree-node-row');
                
                if (level > 0) {
                    const indent = document.createElement('span');
                    indent.className = `indent-${level}`;
                    row.appendChild(indent);
                }

                if (node.children && node.children.length > 0) {
                    const toggleBtn = document.createElement('div');
                    toggleBtn.className = 'toggle-icon';
                    toggleBtn.innerHTML = '<i class="fa-solid fa-chevron-down"></i>';
                    toggleBtn.onclick = (e) => {
                        e.stopPropagation();
                        toggleNode(nodeWrapper, toggleBtn);
                    };
                    row.appendChild(toggleBtn);
                } else {
                    const placeholder = document.createElement('div');
                    placeholder.className = 'toggle-placeholder';
                    row.appendChild(placeholder);
                }

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = true; 
                checkbox.dataset.id = node.id;
                checkbox.onclick = (e) => e.stopPropagation(); 
                checkbox.addEventListener('change', (e) => handleCheck(e.target, nodeWrapper));
                row.appendChild(checkbox);

                const label = document.createElement('span');
                label.innerText = node.label;
                label.style.marginLeft = "4px";
                row.appendChild(label);

                row.onclick = () => checkbox.click();

                nodeWrapper.appendChild(row);

                if (node.children) {
                    const childrenContainer = document.createElement('div');
                    childrenContainer.className = 'children-container';
                    renderTree(node.children, childrenContainer, level + 1);
                    nodeWrapper.appendChild(childrenContainer);
                }

                container.appendChild(nodeWrapper);
            });
        }

        function toggleNode(wrapper, btn) {
            const children = wrapper.querySelector('.children-container');
            if (children.style.display === 'none') {
                children.style.display = 'block';
                btn.classList.remove('collapsed');
            } else {
                children.style.display = 'none';
                btn.classList.add('collapsed');
            }
        }

        function handleCheck(targetCheckbox, wrapper) {
            const isChecked = targetCheckbox.checked;
            
            const children = wrapper.querySelectorAll('.children-container .node-wrapper:not(.hidden) input[type="checkbox"]');
            children.forEach(c => { c.checked = isChecked; c.indeterminate = false; });

            updateParents(wrapper);
            updateGlobalSelectAll();
        }

        function updateParents(element) {
            const parentContainer = element.parentElement.closest('.children-container');
            if (!parentContainer) return;

            const parentWrapper = parentContainer.parentElement;
            const parentCheckbox = parentWrapper.querySelector('.tree-node-row input[type="checkbox"]');
            
            const siblings = Array.from(parentContainer.children)
                .filter(child => !child.classList.contains('hidden'))
                .map(child => child.querySelector('.tree-node-row input[type="checkbox"]'));
            
            if (siblings.length === 0) return; 

            const allChecked = siblings.every(cb => cb.checked);
            const allUnchecked = siblings.every(cb => !cb.checked && !cb.indeterminate);

            parentCheckbox.checked = allChecked;
            parentCheckbox.indeterminate = !allChecked && !allUnchecked;

            updateParents(parentWrapper);
        }

        function updateGlobalSelectAll() {
            const visibleRoots = Array.from(document.querySelectorAll('#treeRoot > .node-wrapper:not(.hidden) input[type="checkbox"]'));
            if(visibleRoots.length === 0) return;

            const all = visibleRoots.every(cb => cb.checked);
            const none = visibleRoots.every(cb => !cb.checked && !cb.indeterminate);
            
            selectAllCheckbox.checked = all;
            selectAllCheckbox.indeterminate = !all && !none;
        }

        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const nodes = document.querySelectorAll('.node-wrapper');
            
            if (!dropdownPanel.classList.contains('active')) {
                dropdownPanel.classList.add('active');
                updateHeight(true);
            }

            if (!term) {
                nodes.forEach(n => n.classList.remove('hidden'));
                selectAllCheckbox.checked = true; 
                return;
            }

            nodes.forEach(n => n.classList.add('hidden'));

            nodes.forEach(node => {
                const label = node.getAttribute('data-label');
                if (label.includes(term)) {
                    showNodeHierarchy(node);
                }
            });
            
            updateGlobalSelectAll();
        });

        function showNodeHierarchy(node) {
            node.classList.remove('hidden');
            let parent = node.parentElement.closest('.children-container');
            while(parent) {
                const wrapper = parent.parentElement;
                wrapper.classList.remove('hidden');
                const btn = wrapper.querySelector('.toggle-icon');
                if(btn && btn.classList.contains('collapsed')) {
                     parent.style.display = 'block';
                     btn.classList.remove('collapsed');
                }
                parent = wrapper.parentElement.closest('.children-container');
            }
            const children = node.querySelectorAll('.node-wrapper');
            children.forEach(c => c.classList.remove('hidden'));
        }

        document.getElementById('okBtn').addEventListener('click', () => {
            const selectedPaths = [];
            const allCheckboxes = document.querySelectorAll('#treeRoot input[type="checkbox"]');
            
            allCheckboxes.forEach(cb => {
                if (cb.checked || cb.indeterminate) {
                    selectedPaths.push({
                        id: cb.dataset.id,
                        status: cb.checked ? 'checked' : 'indeterminate'
                    });
                }
            });

            dropdownPanel.classList.remove('active');
            updateHeight(false);
            searchIcon.classList.replace('fa-magnifying-glass', 'fa-chevron-down');
            
            sendData(selectedPaths);
        });

        document.getElementById('cancelBtn').addEventListener('click', () => {
            dropdownPanel.classList.remove('active');
            updateHeight(false);
            searchIcon.classList.replace('fa-magnifying-glass', 'fa-chevron-down');
        });
    </script>
</body>
</html>